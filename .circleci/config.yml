# CircleCI Configuration with Fan-In/Fan-Out Pattern
# This configuration runs parallel tests and gates deployment on all tests passing

version: 2.1

# Orbs provide reusable packages of configuration
orbs:
  node: circleci/node@7.2.1
  go: circleci/go@3.0.3

# Executors define the environment in which jobs run
executors:
  go-executor:
    docker:
      - image: cimg/go:1.22
    working_directory: ~/project
  
  node-executor:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project/frontend
  
  integration-executor:
    docker:
      - image: cimg/go:1.22-node
    working_directory: ~/project

# Reusable commands
commands:
  restore-go-cache:
    steps:
      - restore_cache:
          keys:
            - go-mod-v1-{{ checksum "go.sum" }}
            - go-mod-v1-
  
  save-go-cache:
    steps:
      - save_cache:
          key: go-mod-v1-{{ checksum "go.sum" }}
          paths:
            - ~/go/pkg/mod
  
  restore-node-cache:
    steps:
      - restore_cache:
          keys:
            - node-deps-v1-{{ checksum "frontend/package-lock.json" }}
            - node-deps-v1-
  
  save-node-cache:
    steps:
      - save_cache:
          key: node-deps-v1-{{ checksum "frontend/package-lock.json" }}
          paths:
            - frontend/node_modules

# Jobs define the actual work to be done
jobs:
  # Security scanning with TruffleHog
  scan-secrets:
    docker:
      - image: us-docker.pkg.dev/thog-artifacts/public/scanner:latest
    steps:
      - checkout
      - run:
          name: "Scan for secrets with TruffleHog"
          command: |
            # Run TruffleHog scanner with config
            /thog scan \
              --config=/root/project/.trufflehog/config.yaml \
              --json > trufflehog-results.json || true
            
            # Show results
            echo "=== TruffleHog Scan Results ==="
            cat trufflehog-results.json
            
            # Fail if secrets found
            if [ -s trufflehog-results.json ]; then
              echo "âŒ Secrets detected! Please remove them before merging."
              exit 1
            else
              echo "âœ… No verified secrets found"
            fi
      - store_artifacts:
          path: trufflehog-results.json

  # Backend linting and static analysis (disabled)
  # backend-lint:
  #   executor: go-executor
  #   steps:
  #     - checkout
  #     - restore-go-cache
  #     - run:
  #         name: "Install golangci-lint"
  #         command: |
  #           curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2
  #     - run:
  #         name: "Run Go linters"
  #         command: |
  #           golangci-lint run --timeout 5m
  #     - run:
  #         name: "Check Go formatting"
  #         command: |
  #           if [ -n "$(gofmt -l .)" ]; then
  #             echo "Go files must be formatted with gofmt. Please run:"
  #             echo "  gofmt -w ."
  #             exit 1
  #           fi
  #     - save-go-cache

  # Backend unit tests (disabled)
  # backend-test:
  #   executor: go-executor
  #   steps:
  #     - checkout
  #     - restore-go-cache
  #     - run:
  #         name: "Download Go dependencies"
  #         command: go mod download
  #     - run:
  #         name: "Run Go unit tests"
  #         command: |
  #           go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
  #     - run:
  #         name: "Generate coverage report"
  #         command: |
  #           go tool cover -html=coverage.out -o coverage.html
  #     - store_test_results:
  #         path: /tmp/test-results
  #     - store_artifacts:
  #         path: coverage.html
  #     - store_artifacts:
  #         path: coverage.out
  #     - save-go-cache

  # Backend build verification (disabled)
  # backend-build:
  #   executor: go-executor
  #   steps:
  #     - checkout
  #     - restore-go-cache
  #     - run:
  #         name: "Build Go application"
  #         command: |
  #           go build -v -o starbucks .
  #     - run:
  #         name: "Verify binary"
  #         command: |
  #           ./starbucks --version || echo "Binary created successfully"
  #           ls -lh starbucks
  #     - persist_to_workspace:
  #         root: .
  #         paths:
  #           - starbucks
  #     - save-go-cache

  # Frontend linting (disabled)
  # frontend-lint:
  #   executor: node-executor
  #   steps:
  #     - checkout:
  #         path: ~/project
  #     - restore-node-cache
  #     - run:
  #         name: "Install dependencies"
  #         command: npm ci
  #     - run:
  #         name: "Run ESLint"
  #         command: npm run lint
  #     - save-node-cache

  # Frontend type checking (disabled)
  # frontend-typecheck:
  #   executor: node-executor
  #   steps:
  #     - checkout:
  #         path: ~/project
  #     - restore-node-cache
  #     - run:
  #         name: "Install dependencies"
  #         command: npm ci
  #     - run:
  #         name: "TypeScript type checking"
  #         command: npx tsc --noEmit
  #     - save-node-cache

  # Frontend unit tests (disabled)
  # frontend-test:
  #   executor: node-executor
  #   steps:
  #     - checkout:
  #         path: ~/project
  #     - restore-node-cache
  #     - run:
  #         name: "Install dependencies"
  #         command: npm ci
  #     - run:
  #         name: "Run frontend tests"
  #         command: |
  #           # Add test command when tests are implemented
  #           echo "Frontend unit tests would run here"
  #           # npm run test:unit -- --coverage
  #     - save-node-cache

  # Frontend build (disabled)
  # frontend-build:
  #   executor: node-executor
  #   steps:
  #     - checkout:
  #         path: ~/project
  #     - restore-node-cache
  #     - run:
  #         name: "Install dependencies"
  #         command: npm ci
  #     - run:
  #         name: "Build frontend"
  #         command: npm run build
  #     - run:
  #         name: "Verify build output"
  #         command: |
  #           ls -la dist/
  #           du -sh dist/
  #     - persist_to_workspace:
  #         root: ~/project
  #         paths:
  #           - frontend/dist
  #     - save-node-cache

  # Integration tests (disabled)
  # integration-test:
  #   executor: integration-executor
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #         at: .
  #     - restore-go-cache
  #     - restore-node-cache
  #     - run:
  #         name: "Install dependencies"
  #         command: |
  #           go mod download
  #           cd frontend && npm ci
  #     - run:
  #         name: "Start backend server"
  #         command: |
  #           go run . &
  #           echo $! > /tmp/server.pid
  #         background: true
  #     - run:
  #         name: "Wait for server to be ready"
  #         command: |
  #           timeout 30 sh -c 'until curl -f http://localhost:8080/playground; do sleep 1; done'
  #     - run:
  #         name: "Run GraphQL API tests"
  #         command: |
  #           # Test GraphQL endpoint
  #           curl -X POST http://localhost:8080/graphql \
  #             -H "Content-Type: application/json" \
  #             -d '{"query":"{ coffees { id name price } }"}' \
  #             | jq .
  #     - run:
  #         name: "Test coffee query"
  #         command: |
  #           response=$(curl -s -X POST http://localhost:8080/graphql \
  #             -H "Content-Type: application/json" \
  #             -d '{"query":"{ coffees { id name price quantityAvailable } }"}')
  #           
  #           echo "$response" | jq .
  #           
  #           # Verify we got coffees back
  #           count=$(echo "$response" | jq '.data.coffees | length')
  #           if [ "$count" -lt 1 ]; then
  #             echo "âŒ No coffees returned"
  #             exit 1
  #           fi
  #           echo "âœ… Found $count coffees"
  #     - run:
  #         name: "Test purchase mutation"
  #         command: |
  #           response=$(curl -s -X POST http://localhost:8080/graphql \
  #             -H "Content-Type: application/json" \
  #             -d '{"query":"mutation { purchaseCoffee(id: "1", quantity: 1) { success message remainingQuantity } }"}')
  #           
  #           echo "$response" | jq .
  #           
  #           success$(echo "$response" | jq -r '.data.purchaseCoffee.success')
  #           if [ "$success" != "true" ]; then
  #             echo "âŒ Purchase failed"
  #             exit 1
  #           fi
  #           echo "âœ… Purchase successful"
  #     - run:
  #         name: "Cleanup"
  #         command: |
  #           if [ -f /tmp/server.pid ]; then
  #             kill $(cat /tmp/server.pid) || true
  #           fi
  #         when: always

  # E2E UI tests with Playwright (disabled)
  # e2e-test:
  #   executor: integration-executor
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #         at: .
  #     - restore-go-cache
  #     - restore-node-cache
  #     - run:
  #         name: "Install Playwright"
  #         command: |
  #           cd frontend
  #           npm ci
  #           npx playwright install --with-deps chromium
  #     - run:
  #         name: "Start application"
  #         command: |
  #           ./starbucks &
  #           echo $! > /tmp/server.pid
  #         background: true
  #     - run:
  #         name: "Wait for application"
  #         command: |
  #           timeout 30 sh -c 'until curl -f http://localhost:8080; do sleep 1; done'
  #     - run:
  #         name: "Run E2E tests"
  #         command: |
  #           cd frontend
  #           npx playwright test || echo "E2E tests would run here when implemented"
  #     - store_artifacts:
  #         path: frontend/playwright-report
  #     - store_artifacts:
  #         path: frontend/test-results
  #     - run:
  #         name: "Cleanup"
  #         command: |
  #           if [ -f /tmp/server.pid ]; then
  #             kill $(cat /tmp/server.pid) || true
  #           fi
  #         when: always

  # Performance tests (disabled)
  # performance-test:
  #   executor: integration-executor
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #         at: .
  #     - run:
  #         name: "Install k6"
  #         command: |
  #           sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
  #           echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
  #           sudo apt-get update
  #           sudo apt-get install k6
  #     - run:
  #         name: "Start application"
  #         command: |
  #           ./starbucks &
  #           echo $! > /tmp/server.pid
  #         background: true
  #     - run:
  #         name: "Wait for application"
  #         command: |
  #           timeout 30 sh -c 'until curl -f http://localhost:8080; do sleep 1; done'
  #     - run:
  #         name: "Run load tests"
  #         command: |
  #           k6 run - \<<'EOF'
  #           import http from 'k6/http';
  #           import { check, sleep } from 'k6';
  #
  #           export let options = {
  #             stages: [
  #               { duration: '30s', target: 10 },
  #               { duration: '1m', target: 10 },
  #               { duration: '30s', target: 0 },
  #             ],
  #             thresholds: {
  #               http_req_duration: ['p(95)<500'],
  #             },
  #           };
  #
  #           export default function () {
  #             const query = JSON.stringify({
  #               query: '{ coffees { id name price } }'
  #             });
  #
  #             const res = http.post('http://localhost:8080/graphql', query, {
  #               headers: { 'Content-Type': 'application/json' },
  #             });
  #
  #             check(res, {
  #               'status is 200': (r) => r.status === 200,
  #               'has coffees': (r) => JSON.parse(r.body).data.coffees.length > 0,
  #             });
  #
  #             sleep(1);
  #           }
  #           EOF
  #     - run:
  #         name: "Cleanup"
  #         command: |
  #           if [ -f /tmp/server.pid ]; then
  #             kill $(cat /tmp/server.pid) || true
  #           fi
  #         when: always

  # Deploy job (disabled)
  # deploy:
  #   executor: go-executor
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #         at: .
  #     - run:
  #         name: "Deploy application"
  #         command: |
  #           echo "ðŸš€ Deploying to production..."
  #           echo "All tests passed! Ready for deployment."
  #           # Add actual deployment commands here
  #           # e.g., docker build, push to registry, deploy to k8s, etc.

# Workflows orchestrate jobs with fan-in/fan-out pattern (simplified to scan-secrets only)
workflows:
  version: 2

  test-and-deploy:
    jobs:
      - scan-secrets

  nightly:
    triggers:
      - schedule:
          cron: "0 2 * * *"
          filters:
            branches:
              only: main
    jobs:
      - scan-secrets
